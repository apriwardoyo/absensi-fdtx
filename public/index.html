<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Absensi Karyawan</title>
  <style>
    body { font-family: system-ui, Arial; max-width: 900px; margin: 28px auto; padding: 0 16px; }
    h1 { margin-bottom: 8px; }
    form { margin: 16px 0 24px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    input, button { padding:8px 10px; font-size:14px; border-radius:6px; border:1px solid #ccc; }
    button { cursor:pointer; }
    ul { padding-left: 18px; }
    .msg { margin: 8px 0; color: #555; }
    .error { color: #b00020; }
    .card { padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.04); margin-bottom:8px; }
    .meta { font-size:12px; color:#666; }
  </style>
</head>
<body>
  <h1>Daftar Nama Karyawan (Absensi)</h1>

  <div class="msg" id="status">Memuat data…</div>

  <div id="list"></div>

  <hr/>

  <h2>Tambah Absensi</h2>
  <form id="form">
    <input type="text" id="nama" placeholder="Nama karyawan" required />
    <select id="statusSelect">
      <option value="hadir">Hadir</option>
      <option value="ijin">Izin</option>
      <option value="sakit">Sakit</option>
    </select>
    <button type="submit">Simpan</button>
  </form>

  <script>
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('list');
    const form = document.getElementById('form');

    async function fetchAbsensi() {
      statusEl.textContent = 'Memuat data…';
      try {
        const res = await fetch('/absensi');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          listEl.innerHTML = '<div class="card">Belum ada data absensi.</div>';
          statusEl.textContent = 'Selesai — tidak ada data.';
          return;
        }

        // Tampilkan nama karyawan (unik) dan daftar entri
        // Jika ingin hanya menampilkan nama unik:
        const uniqueNames = Array.from(new Set(data.map(d => (d.nama || '').trim()).filter(Boolean)));

        let html = '<div class="card"><strong>Nama karyawan (unik):</strong><ul>';
        uniqueNames.forEach(n => html += '<li>' + escapeHtml(n) + '</li>');
        html += '</ul></div>';

        html += '<div class="card"><strong>Semua entri absensi:</strong><ul>';
        data.forEach(item => {
          const tgl = item.tanggal ? new Date(item.tanggal).toLocaleString() : '-';
          html += `<li><strong>${escapeHtml(item.nama || '(no name)')}</strong> — <span class="meta">${tgl} • ${escapeHtml(item.status || '')}</span></li>`;
        });
        html += '</ul></div>';

        listEl.innerHTML = html;
        statusEl.textContent = 'Selesai — data berhasil dimuat.';
      } catch (err) {
        console.error(err);
        listEl.innerHTML = '';
        statusEl.textContent = 'Gagal memuat data.';
        statusEl.classList.add('error');
      }
    }

    // escape sederhana
    function escapeHtml(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    // kirim form POST ke /absensi
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const nama = document.getElementById('nama').value.trim();
      const status = document.getElementById('statusSelect').value;
      if (!nama) return alert('Masukkan nama karyawan');

      try {
        const res = await fetch('/absensi', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nama, status })
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({message: 'Server error'}));
          throw new Error(err.message || ('HTTP ' + res.status));
        }
        document.getElementById('nama').value = '';
        await fetchAbsensi(); // refresh list
      } catch (err) {
        alert('Gagal menyimpan: ' + err.message);
      }
    });

    // muat saat halaman dibuka
    fetchAbsensi();
  </script>
</body>
</html>
